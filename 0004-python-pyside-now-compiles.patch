From 8d2b0e5429c48c930531b7bd2d29e1aab01c79bd Mon Sep 17 00:00:00 2001
From: svolpe <shanevolpe@gmail.com>
Date: Wed, 10 Oct 2012 19:37:01 -0400
Subject: [PATCH 4/8] python-pyside now compiles

---
 .../pyside/files/no-accessibility-support.patch    | 28 ++++----
 recipes-pyside/pyside/files/support-qws.patch      | 37 ++++++++--
 recipes-pyside/pyside/libshiboken_git.bb           | 12 +++-
 recipes-pyside/pyside/python-pyside_git.bb         | 78 ++++++++++------------
 4 files changed, 91 insertions(+), 64 deletions(-)

diff --git a/recipes-pyside/pyside/files/no-accessibility-support.patch b/recipes-pyside/pyside/files/no-accessibility-support.patch
index cf3c367..83a5231 100644
--- a/recipes-pyside/pyside/files/no-accessibility-support.patch
+++ b/recipes-pyside/pyside/files/no-accessibility-support.patch
@@ -1,7 +1,16 @@
-diff -Naur pyside-qt4.7+1.0.2-orig/PySide/QtGui/CMakeLists.txt pyside-qt4.7+1.0.2/PySide/QtGui/CMakeLists.txt
---- pyside-qt4.7+1.0.2-orig/PySide/QtGui/CMakeLists.txt	2011-04-28 22:43:01.000000000 +0200
-+++ pyside-qt4.7+1.0.2/PySide/QtGui/CMakeLists.txt	2011-05-03 16:12:39.316884000 +0200
-@@ -90,7 +90,6 @@
+--- git/PySide/QtGui/typesystem_gui_common.xml~org	2012-10-08 20:16:02.221237113 -0400
++++ git/PySide/QtGui/typesystem_gui_common.xml	2012-10-08 20:18:35.842317152 -0400
+@@ -3058,7 +3058,6 @@
+   </object-type>
+   <object-type name="QMouseEvent" copyable= "false" polymorphic-id-expression="%1-&gt;type() == QEvent::MouseButtonDblClick || %1-&gt;type() == QEvent::MouseButtonPress || %1-&gt;type() == QEvent::MouseButtonRelease || %1-&gt;type() == QEvent::MouseMove"/>
+   <object-type name="QPaintEvent" copyable= "false" polymorphic-id-expression="%1-&gt;type() == QEvent::Paint"/>
+-  <object-type name="QAccessibleEvent" polymorphic-id-expression="%1-&gt;type() == QEvent::AccessibilityDescription || %1-&gt;type() == QEvent::AccessibilityHelp"/>
+   <object-type name="QGestureEvent" polymorphic-id-expression="%1-&gt;type() == QEvent::Gesture || %1-&gt;type() == QEvent::GestureOverride" since="4.6">
+     <modify-function signature="activeGestures()const">
+       <modify-argument index="return">
+--- git/PySide/QtGui/CMakeLists.txt~org	2012-10-08 20:16:34.161088857 -0400
++++ git/PySide/QtGui/CMakeLists.txt	2012-10-08 20:16:52.611035588 -0400
+@@ -98,7 +98,6 @@
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qabstracttextdocumentlayout_paintcontext_wrapper.cpp
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qabstracttextdocumentlayout_selection_wrapper.cpp
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qabstracttextdocumentlayout_wrapper.cpp
@@ -9,14 +18,3 @@ diff -Naur pyside-qt4.7+1.0.2-orig/PySide/QtGui/CMakeLists.txt pyside-qt4.7+1.0.
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qactionevent_wrapper.cpp
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qactiongroup_wrapper.cpp
  ${CMAKE_CURRENT_BINARY_DIR}/PySide/QtGui/qaction_wrapper.cpp
-diff -Naur pyside-qt4.7+1.0.2-orig/PySide/QtGui/typesystem_gui_common.xml pyside-qt4.7+1.0.2/PySide/QtGui/typesystem_gui_common.xml
---- pyside-qt4.7+1.0.2-orig/PySide/QtGui/typesystem_gui_common.xml	2011-04-28 22:43:01.000000000 +0200
-+++ pyside-qt4.7+1.0.2/PySide/QtGui/typesystem_gui_common.xml	2011-05-03 16:12:23.926884000 +0200
-@@ -2809,7 +2809,6 @@
-   </object-type>
-   <object-type name="QMouseEvent" copyable= "false" polymorphic-id-expression="%1-&gt;type() == QEvent::MouseButtonDblClick || %1-&gt;type() == QEvent::MouseButtonPress || %1-&gt;type() == QEvent::MouseButtonRelease || %1-&gt;type() == QEvent::MouseMove"/>
-   <object-type name="QPaintEvent" copyable= "false" polymorphic-id-expression="%1-&gt;type() == QEvent::Paint"/>
--  <object-type name="QAccessibleEvent" polymorphic-id-expression="%1-&gt;type() == QEvent::AccessibilityDescription || %1-&gt;type() == QEvent::AccessibilityHelp"/>
-   <object-type name="QGestureEvent" polymorphic-id-expression="%1-&gt;type() == QEvent::Gesture || %1-&gt;type() == QEvent::GestureOverride">
-     <modify-function signature="activeGestures()const">
-       <modify-argument index="return">
diff --git a/recipes-pyside/pyside/files/support-qws.patch b/recipes-pyside/pyside/files/support-qws.patch
index 4d85555..d039d48 100644
--- a/recipes-pyside/pyside/files/support-qws.patch
+++ b/recipes-pyside/pyside/files/support-qws.patch
@@ -19,10 +19,38 @@ diff -Naur pyside-qt4.7+1.0.2-orig/CMakeLists.txt pyside-qt4.7+1.0.2/CMakeLists.
  else()
      message(FATAL_ERROR "OS not supported")
  endif()
-diff -Naur pyside-qt4.7+1.0.2-orig/PySide/QtGui/typesystem_gui_qws.xml pyside-qt4.7+1.0.2/PySide/QtGui/typesystem_gui_qws.xml
---- pyside-qt4.7+1.0.2-orig/PySide/QtGui/typesystem_gui_qws.xml	1970-01-01 01:00:00.000000000 +0100
-+++ pyside-qt4.7+1.0.2/PySide/QtGui/typesystem_gui_qws.xml	2011-05-25 23:02:02.830307000 +0200
-@@ -0,0 +1,22 @@
+--- /dev/null	2012-06-06 10:06:23.975309641 -0400
++++ git/PySide/QtCore/typesystem_core_qws.xml	2012-10-08 14:53:47.952118932 -0400
+@@ -0,0 +1,26 @@
++<?xml version="1.0"?>
++<!--
++    This file is part of PySide project.
++    Copyright (C) 2011 Nokia Corporation and/or its subsidiary(-ies).
++    Contact: PySide team <contact@pyside.org>
++
++    This library is free software; you can redistribute it and/or
++    modify it under the terms of the GNU Lesser General Public
++    License as published by the Free Software Foundation; either
++    version 2.1 of the License, or (at your option) any later version.
++
++    This library is distributed in the hope that it will be useful,
++    but WITHOUT ANY WARRANTY; without even the implied warranty of
++    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
++    Lesser General Public License for more details.
++
++    You should have received a copy of the GNU Lesser General Public
++    License along with this library; if not, write to the Free Software
++    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
++-->
++<typesystem package="PySide.QtCore">
++  <primitive-type name="Qt::HANDLE" target-lang-api-name="PyLong">
++    <!-- FIXME APIExtractor or shiboken do not support multiple includes by primitive type -->
++    <include file-name="QTextDocument" location="global"/>
++  </primitive-type>
++</typesystem>
+--- /dev/null	2012-06-06 10:06:23.975309641 -0400
++++ git/PySide/QtGui/typesystem_gui_qws.xml	2012-10-10 13:03:56.242335434 -0400
+@@ -0,0 +1,23 @@
 +<?xml version="1.0"?>
 +<!--
 +    This file is part of PySide project.
@@ -44,4 +72,5 @@ diff -Naur pyside-qt4.7+1.0.2-orig/PySide/QtGui/typesystem_gui_qws.xml pyside-qt
 +    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 +-->
 +<typesystem package="PySide.QtGui">
++	<rejection class="QApplication" function-name="setArgs"/>
 +</typesystem>
diff --git a/recipes-pyside/pyside/libshiboken_git.bb b/recipes-pyside/pyside/libshiboken_git.bb
index 14355ae..8476bc2 100644
--- a/recipes-pyside/pyside/libshiboken_git.bb
+++ b/recipes-pyside/pyside/libshiboken_git.bb
@@ -11,8 +11,7 @@ LIC_FILES_CHKSUM = "file://COPYING;md5=34337af480a8c452bfafe22a78fa20cb"
 SRC_URI = "git://gitorious.org/pyside/shiboken.git;protocol=git;tag=eb293c2839cfbc726f0e085e1435c94b6f6561f9 \
 			  file://MacroPushRequiredVars.cmake \
 			  file://FindQt4.cmake \
-			  file://fix-shiboken-cmake-config.patch \
-			  file://generator-rename-shiboken-dir.patch \
+			  file://rename-shiboken-pkg.patch \
 			  "
 
 S = "${WORKDIR}/git"
@@ -77,10 +76,17 @@ export BUILD_SYS
 export STAGING_LIBDIR
 export STAGING_INCDIR
 
-do_configure_prepend() {
+addtask do_fix_generator_names after do_patch before do_configure
+
+do_fix_generator_names() {
     mv ${S}/generator/shiboken ${S}/generator/shiboken-src
+    ln -s ${STAGING_BINDIR_NATIVE}/shiboken ${S}/generator/shiboken
 }
 
+FILES_${PN}-gdb += "${libdir}/python2.7/site-packages/.debug/shiboken*"
+FILES_${PN}-dev += "${libdir}/cmake/ ${libdir}/pkgconfig"
+FILES_${PN} += "${libdir}/python2.7/site-packages/shiboken*"
+
 #do_configure_prepend() {
 #   cp ${WORKDIR}/MacroPushRequiredVars.cmake ${S}/cmake/Modules/MacroPushRequiredVars.cmake
 #   cp ${WORKDIR}/FindQt4.cmake ${S}/cmake/Modules/FindQt4.cmake
diff --git a/recipes-pyside/pyside/python-pyside_git.bb b/recipes-pyside/pyside/python-pyside_git.bb
index 5063e31..92c6d37 100644
--- a/recipes-pyside/pyside/python-pyside_git.bb
+++ b/recipes-pyside/pyside/python-pyside_git.bb
@@ -17,54 +17,48 @@ SRC_URI = "git://gitorious.org/pyside/pyside.git;protocol=git;tag=6df4b307c5aec7
 			  file://support-qws.patch \
 	 			file://MacroPushRequiredVars.cmake \
 				file://FindQt4.cmake \
+	         file://no-accessibility-support.patch \
 "
-# file://MacroPushRequiredVars.cmake \
 
 # NOTE this should be reworked when a x11 version of qt4 is needed
-inherit cmake	
-EXTRA_OECMAKE = " \
-	-DSITE_PACKAGE=${STAGING_LIBDIR}/python2.7/site-packages \
-	-DPYTHON_INCLUDE_DIR:PATH=${STAGING_INCDIR}/python2.7 \
-	-DPYTHON_LIBRARIES:PATH=${STAGING_LIBDIR}/python2.7 \
-   -DQT_LIBRARY_DIR=${STAGING_INCDIR} \
-   -DQT_HEADERS_DIR=${STAGING_INCDIR}/qtopia \
-   -DQT_QTCORE_INCLUDE_DIR=${STAGING_INCDIR}/qtopia/QtCore \
-"
-#EXTRA_OECMAKE += " \
-#	-DSITE_PACKAGE=${STAGING_LIBDIR}/python2.7/site-packages \
-#	-DPYTHON_INCLUDE_DIR:PATH=${STAGING_INCDIR}/python2.7 \
-#   -DQT_INCLUDE_DIR:PATH=${OE_QMAKE_INCDIR_QT} \
-#   -DQT_LIBRARY_DIR=${STAGING_TARGET_LIBDIR} \
-#   -DQT_LIBINFIX=${QT_LIBINFIX} \
-#   -DQT_DIR_NAME=${QT_DIR_NAME} \
-#   -DCMAKE_LIBRARY_PATH=${STAGING_TARGET_LIBDIR} \
-#   -DCMAKE_TOOLCHAIN_SYSTEM_ROOT:PATH=${STAGING_DIR_TARGET} \
-#   -DCMAKE_STAGING_DIR_TARGET:PATH=${STAGING_DIR_TARGET} \
-#   -DCMAKE_STAGING_DIR_NATIVE:PATH=${STAGING_DIR_NATIVE} \
-#   -DCMAKE_TOOLCHAIN_SYSTEM_ROOT:PATH=${STAGING_DIR_TARGET} \
-#   -DCMAKE_STAGING_DIR_TARGET:PATH=${STAGING_DIR_TARGET} \
-#   -DQT_INSTALL_LIBS=${OE_QMAKE_LIBDIR_QT} \
-#   -DQT_INCLUDE_DIR=${OE_QMAKE_INCDIR_QT} \
-#   -DQT_QTCORE_INCLUDE_DIR=${OE_QMAKE_INCDIR_QT}/QtCore \
-#"
+inherit cmake
 
-#do_generate_toolchain_file_append() {
-#   # even search in shiboken cmake modules path for modules
-#   echo "set( CMAKE_MODULE_PATH ${STAGING_LIBDIR}/cmake/Shiboken-${PV} \${CMAKE_MODULE_PATH} )" >> ${WORKDIR}/toolchain.cmake
-#   echo "set( CMAKE_MODULE_PATH ${S}/cmake/Modules \${CMAKE_MODULE_PATH} )" >> ${WORKDIR}/toolchain.cmake
-#   echo "set( PYTHON_INCLUDE_DIR ${STAGING_INCDIR}/python2.7 )" >> ${WORKDIR}/toolchain.cmake
-#}
+PYTHON_DIR="python2.7"
 
-#do_configure_prepend() {
-#   mkdir -p ${S}/cmake/Modules
-#   cp ${WORKDIR}/FindQt4.cmake ${S}/cmake/Modules/FindQt4.cmake
-#   cp ${WORKDIR}/MacroPushRequiredVars.cmake ${S}/cmake/Modules/MacroPushRequiredVars.cmake
-#}
+OECMAKE_CXX_FLAGS_append=" -DQ_WS_QWS "
+CXX_DEFINES+=" -DQ_WS_QWS "
+QT_LIBINFIX="E"
 
-#do_configure_prepend() {
-#   mkdir -p ${S}/cmake/Modules
-#   cp ${WORKDIR}/MacroPushRequiredVars.cmake ${S}/cmake/Modules/MacroPushRequiredVars.cmake
-#}
+export CXX_DEFINES
+
+#linux-arm-gnueabi-g++
+OE_CMAKE_AR = "${STAGING_BINDIR_TOOLCHAIN}/${AR}"
+EXTRA_OECMAKE += " \
+						 -DCMAKE_AR=${OE_CMAKE_AR} \
+   					 -DQT_LIBINFIX=${QT_LIBINFIX} \
+						 -DQT_MKSPECS_DIR=${STAGING_DATADIR}/qtopia/mkspecs/qws/linux-arm-gnueabi-g++/ \
+				       -DQT_INCLUDE_DIR:PATH=${STAGING_INCDIR}/qtopia/ \
+						 -DQT_HEADERS_DIR:PATH=${STAGING_INCDIR}/qtopia \
+						 -DQT_QTCORE_INCLUDE_DIR:PATH=${STAGING_INCDIR}/qtopia/QtCore \
+						 -DQT_QTCORE_LIBRARY:FILE=${STAGING_LIBDIR}/libQtCoreE.so \
+						 -DQT_QTCORE_LIBRARY_RELEASE:FILE=${STAGING_LIBDIR}/libQtCoreE.so \
+   					 -DSITE_PACKAGE=${STAGING_LIBDIR}/python2.7/site-packages \
+   					 -DPYTHON_INCLUDE_DIR:PATH=${STAGING_INCDIR}/python2.7 \
+   					 -DPYTHON_LIBRARIES:PATH=${STAGING_LIBDIR}/python2.7 \
+                   -DQT_HEADERS_DIR=${STAGING_INCDIR}/qtopia \
+						 -DSHIBOKEN_INCLUDE_DIR:PATH=${STAGING_INCDIR}/shiboken \
+						 -DCMAKE_LIBRARY_PATH=${STAGING_LIBDIR} \
+"
+
+FILES_${PN} =+ " \
+   ${libdir}/${PYTHON_DIR}/site-packages/PySide/*.so \
+   ${libdir}/${PYTHON_DIR}/site-packages/PySide/*.py \
+"
+FILES_${PN}-dbg =+ "${libdir}/${PYTHON_DIR}/site-packages/PySide/.debug"
+#FILES_${PN}-dev =+ " \
+#   ${datadir}/PySide/typesystems \
+#   ${libdir}/cmake \
+#"
 
 LICENSE = "GPLv2"
 LIC_FILES_CHKSUM = "file://COPYING;md5=15a1ca44f90f3ab457d6a4fe7c0f3a19"
-- 
1.8.5.2 (Apple Git-48)

